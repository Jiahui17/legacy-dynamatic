#!/bin/env bash
function fail {
	printf '%s\n' "$1" >&2 # message to stderr
	exit "${2-1}"          # return code specified by $2, or 1 by default
}

# top-level file (remember to change these variables accordingly)
PROJ_DIR="."
PROJ_NAME=$(basename $(ls ${PROJ_DIR}/src/*.cpp| head -1) | sed 's/.cpp//g')
TOP_FILE="${PROJ_NAME}.cpp"

#============================================================================================================#

# clock period
for i in "$@"; do
	case $i in
	-c=*|--clock_period=*|-period=*)
	CLOCK_PERIOD="${i#*=}"
	shift ;;
	*) ;;
	esac
done

DEFAULT_PERIOD=6

[ -z "$CLOCK_PERIOD" ] && \
	echo "info - clock period is not set: using default cp=${DEFAULT_PERIOD}" && \
	CLOCK_PERIOD=${DEFAULT_PERIOD}

#============================================================================================================#

# run the elastic pass
echo "info - Start synthesize."
compile "${TOP_FILE}" "${PROJ_DIR}"  \
	|| fail "error - elastic pass failed!"

# run buffer pass
echo "info - Start optimize."
buffers buffers \
	-filename="${PROJ_DIR}/reports/${PROJ_NAME}" \
	-period=${CLOCK_PERIOD} \
	-solver=cbc \
	-timeout=360 \
	| tee "${PROJ_DIR}/reports/buffers.log" \
	|| fail 'error - buffers failed!'

mv "${PROJ_DIR}/reports/${PROJ_NAME}"{_graph_buf,_optimized}.dot

rm $PROJ_DIR/*.{lp,gsol}

rm -f delays_output.txt tmp_delays.txt

# convert the dot netlist to hdl netlist
echo "info - Start write hdl netlist"
write_hdl "${PROJ_DIR}" "${PROJ_DIR}/reports/${PROJ_NAME}_optimized" \
	|| fail "error - write_hdl failed!"

# output the visualization in pdf format
dot -O -Tpdf "${PROJ_DIR}"/reports/*.dot

cd ../..
rm ${PROJ_DIR}/hdl/glbl.v ${PROJ_DIR}/hdl/*.tcl 2> /dev/null

exit 0 # comment out!
