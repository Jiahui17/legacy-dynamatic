#!/bin/bash

function fail {
	printf '[ERROR] %s\n' "$1" >&2 # message to stderr
	exit "${2-1}"          # return code specified by $2, or 1 by default
}

# if vsim is not in the default search path:
[ -x "$(which vsim)" ] || {
	# change these lines
	export PATH=${PATH}:~/intelFPGA/21.1/questa_fse/bin/;
	export MGLS_LICENSE_FILE=~/intelFPGA/LR-090565_License.dat
}

[ -x $(which vsim) ] || fail "cannot find vsim executable"

# top-level file (remember to change these variables accordingly)
PROJ_DIR=$(readlink -f ".")
PROJ_NAME=$(basename $(ls ${PROJ_DIR}/src/*.cpp| head -1) | sed 's/.cpp//g')
TOP_FILE="${PROJ_NAME}.cpp"

#=========================================================================================#

mkdir -p "${PROJ_DIR}/sim/"{C_SRC,VHDL_SRC,REF_OUT,HLS_VERIFY,INPUT_VECTORS,VHDL_OUT}

# root directory of verify project
VERIFY_ROOT="${PROJ_DIR}/sim"

# copy the c++ source code into directory C_SRC
cp "${PROJ_DIR}"/src/*.{cpp,h} "${VERIFY_ROOT}"/C_SRC 2> /dev/null

# copy the hdl source code into directory VHDL_SRC
cp "${PROJ_DIR}"/hdl/* "${VERIFY_ROOT}"/VHDL_SRC 2> /dev/null

rm -r "${PROJ_DIR}/sim/HLS_VERIFY/work" 2> /dev/null

# verifier requires you to be in HLS_VERIFY directory to work
cd "${PROJ_DIR}/sim/HLS_VERIFY"

# run the verifier and save the log
hlsverifier cover -aw32 "../C_SRC/${TOP_FILE}" "../C_SRC/${TOP_FILE}" "${PROJ_NAME}" \
	| tee ${PROJ_DIR}/reports/hls_verify.log
